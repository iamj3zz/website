<!-- Google Analytics 4 (Privacy-Compliant with Cookie Consent) -->
{% if site.google_analytics %}
<script>
  // Function to load Google Analytics
  function loadGoogleAnalytics() {
    // Only load if not already loaded
    if (window.gaLoaded) return;

    // Check if analytics cookies are consented
    const cookieConsent = localStorage.getItem('cookieConsent');
    if (!cookieConsent) return; // No consent given yet

    const consent = JSON.parse(cookieConsent);
    if (!consent.analytics) return; // Analytics not consented

    // Load Google Analytics
    const script1 = document.createElement('script');
    script1.async = true;
    script1.src = 'https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}';
    document.head.appendChild(script1);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ site.google_analytics }}', {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });

    window.gaLoaded = true;
  }

  // Try to load analytics on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleAnalytics);
  } else {
    loadGoogleAnalytics();
  }

  // Listen for consent changes
  window.addEventListener('cookieConsentUpdated', loadGoogleAnalytics);
</script>
{% endif %}
